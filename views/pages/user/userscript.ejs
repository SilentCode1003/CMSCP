<script>
    $(document).ready(function () {
      LoadTable();
      let userId = '';
    $("#datatable").on('click', '.status-btn', function () {
    var rowData = $(this).closest('tr').find('td').map(function () {
        return $(this).text();
    }).get();
    var statusCell = $(this).closest('tr').find('td:eq(5)'); 
    var status = statusCell.text(); 
    var newStatus = status === "Active" ? "Inactive" : "Active";
    statusCell.text(newStatus); 
 
    var icon = newStatus === "Active" ? "fas fa-eye" : "far fa-eye-slash";
    $(this).find('i').removeClass().addClass(icon); 
});
      $("#datatable").on('click', 'tr', function(){
        var dataRow = [];
        $(this).closest('tr').find('td').each(function(){
          dataRow.push($(this).text());
        });
        console.log(dataRow)
        userId = dataRow[0];
      console.log("Clicked userId:", userId)

      });

      function LoadTable() {
        console.log("eto na gumagana na");
  
        $("#datatable").DataTable({
          destroy: true,
          processing: true,
          serverSide: true,
          paging: false,
          searching: false,
          info: false,
          scrollY: 400,
          scrollCollapse: true,
          serverMethod: "GET",
          ajax: {
            url: "/user/load",
            dataSrc: (json) => {
              var finalData = [];
              var data = json.data;
              console.log(data);
              $.each(data, (key, item) => {
                finalData.push({
                  id: item.ID,
                  fullname: item.fullname,
                  username: item.username,
                  password: item.password,
                  access: item.accessType,
                  status: item.status,
                  createdby: item.createdBy,
                  createdDate: new Date(item.createdDate).toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                  action: `
                                      <button class="edit-btn" data-id="${item.ID}" data-toggle="modal" data-target="#staticmodalupdate">
                                      <i class="fas fa-edit"></i>
                                      </button>

  
                                      <button class="delete-btn" data-id="${item.ID}">
                                      <i class="fas fa-trash-alt"></i> 
                                      </button>
                                      <button class="status-btn">
                                      <i class="fas fa-eye"></i>
                                      </button>
                            `,
                });
  
              
              });
  
              return finalData;
            },
          },
          columnDefs: [
            {
              targets: 1,
              className: "td-indent",
            },
          ],
          columns: [
            { data: "id" },
            { data: "fullname" },
            { data: "username" },
            { data: "password" },
            { data: "access" },
            { data: "status" },
            { data: "createdby" },
            { data: "createdDate" },
            { data: "action" },
          ],
          initComplete: function () {
            console.log("init complete");
            // hideload();
          },
        });
      }
  $("#save-button").on("click", function () {
    var fullname = $("#fullname").val();
    var username = $("#username").val();
    var password = $("#password").val();
    var accesstype = $("#accesstype").val();

    
    var status = "Active";
    var createdBy = "Admin"; 
    var createdDate = new Date().toISOString(); 

    $.ajax({
        url: "/user/save",
        method: "POST",
        data: {
            fullname: fullname,
            username: username,
            password: password,
            accesstype: accesstype,
            status: status,
            createdBy: createdBy,
            createdDate: createdDate
        },
        success: function (response) {
            if (response && response.msg === "success") {
                $("#fullname").val("");
                $("#username").val("");
                $("#password").val("");
                $("#accesstype").val("");

                $("#staticmodal").modal("hide");
                $('#datatable').DataTable().ajax.reload();
                Swal.fire({
                    position: "top-center",
                    icon: "success",
                    title: "Data Saved successfully!",
                    message: "Sample Message",
                    showConfirmButton: true,
                    timer: 1500
                });
            } else {
              Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error saving data. Please try again.',
                });
            }
        }
    });
});


$(".edit-btn").on("click", function () {
    var userId = $(this).data("id");
    console.log("User ID:", userId);
    $("#userid").val(userId); 
});

$("#update-button").on("click", function () {
    let fname = $("#fullnameupd").val(); 
    let username = $("#usernameupd").val(); 
    let password = $("#passwordupd").val(); 
    let accesstype = $("#accesstypeupd").val();
    let message = "";
    
    if(fname === ""){
        message += "Empty Fullname";
    }
    console.log(message)

    console.log("Fullname: ", fname, "username:", username, "password:", password, "accesstype:", accesstype)

    Swal.fire({
        title: "Do you want to save the changes?",
        showCancelButton: true,
        confirmButtonText: "Save",
        icon: "info"
    }).then((result) => {
        
        if (result.isConfirmed) {
            
            $.ajax({
                url: "/user/edit",
                method: "PUT",
                data: {
                    userId: userId,
                    fullname: fname,
                    username: username,
                    password: password,
                    accesstype: accesstype,
                },
                success: function (response) {
                    if (response && response.msg === "success") {
                        $("#staticmodalupdate").modal("hide");
                        $('#datatable').DataTable().ajax.reload();
                        Swal.fire("Updated Successfully!", "", "success");
                    } else {
                        alert("Error updating data. Please try again.");
                    }
                },
                error: function () {
                    alert("Error updating data. Please try again.");
                }
            });
        } else if (result.isDenied) {
            Swal.fire("Changes are not saved", "", "info");
        }
    });
});


function handleDeleteButtonClick() {
    $('#datatable').on('click', '.delete-btn', function () {
        var userId = $(this).data('id');
        
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            
            if (result.isConfirmed) {
             
                $.ajax({
                    url: '/user/delete/' + userId,
                    method: 'DELETE',
                    success: function (response) {
                        if (response && response.msg === 'success') {
                            $('#datatable').DataTable().ajax.reload();
                            Swal.fire("Deleted Successfully!", "", "success");
                        } else {
                            alert('Error deleting user. Please try again.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error deleting user:', error);
                        alert('Error deleting user. Please try again.');
                    }
                });
            }
        });
    });
}

handleDeleteButtonClick();


       
$(document).on("click", "#addbtn", function () {
         console.log("triggered")
        $("#staticmodal").modal("show");
    })

    $(document).on("click", "#buttonclose", function () {
        $("#staticmodal").modal("hide");
    });

    $(document).on("click", "#buttoncloseX", function () {
        $("#staticmodal").modal("hide");
    });
    $(document).on("click", "#buttonclose", function () {
        $("#staticmodalupdate").modal("hide");
    });

   
    $(document).on("click", "#buttoncloseX", function () {
        $("#staticmodalupdate").modal("hide");
    });
  })
  </script>
  